name: CI

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  test:
    name: Unit Tests
    runs-on: ubuntu-22.04

    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 1
      - name: Set up JDK
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '19'

      - name: Run TinkerGraph tests
        run: sbt coverage "project tinkergraph" test
      - name: Run unit and inmem database tests
        run: sbt coverage test
      - name: Run Neo4j integration tests
        run: sbt coverage "NeoTest / test"
      - name: Run TigerGraph integration tests
        run: |
          curl https://docs.tigergraph.com/tigergraph-server/3.5/gsql-shell/_attachments/gsql_client_server353.jar --output gsql_client.jar
          export GSQL_HOME=`pwd`/gsql_client.jar
          sbt coverage "TgTest / test"

      - name: Compile coverage report
        run: sbt coverageReport
      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v1
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          directory: ./target/scala-2.13/scoverage-report/

  formatting:
    name: Code Formatting Check
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 1
      - name: Set up JDK
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '19'
      - name: Check formatting
        run: sbt scalafmtCheck
      - run: echo "Previous step failed because code is not formatted. Run 'sbt scalafmt'"
        if: ${{ failure() }}